# IDTF V3.1 技術白皮書：NDH V3.1 設計文件

## 1. 引言

本章節詳細闡述 IDTF (Industrial Digital Twin Framework) V3.1 版本中，NDH (Native Digital Hub) 的設計理念、核心架構與關鍵技術實現。NDH 作為 IDTF 的核心組件之一，旨在提供一個開放、中立、低成本且涵蓋全生命週期（設計、建造、運維）的數位協作與資料整合平台。本設計文件將著重於 NDH 如何實現高效的 MEP (Mechanical, Electrical, Plumbing) 設計、精確的衝突檢測、自動化的 ISO 圖面生成、深入的流體分析以及即時協同作業能力，並將所有功能定位為 IDTF 的原生能力，以避免供應商鎖定。

## 2. IDTF V2 核心理念的整合

IDTF V3.1 的 NDH 設計深度整合了 IDTF V2 的核心理念，確保框架的開放性、可負擔性與全面性：

*   **開源中立，無供應商鎖定**：NDH 的設計基於開放標準和開源技術棧，避免對特定商業軟體或平台產生依賴。所有核心功能均由 IDTF 框架原生提供，確保用戶資料和工作流程的自主可控性。
*   **低成本，中小企業可負擔**：透過採用高效的演算法和優化的資源管理，NDH 旨在降低數位化轉型的門檻，使中小企業也能夠負擔並受益於先進的數位孿生技術。
*   **全生命週期覆蓋**：NDH 從設計階段的資料整合與協同，到建造階段的進度追蹤與品質控制，再到運維階段的效能監測與預測性維護，提供端到端的數位化解決方案。
*   **基於 IADL + NDH + Omniverse 三大核心組件**：NDH 與 IDTF 的其他核心組件——IADL (Industrial Asset Description Language) 和 Omniverse (作為通用資料交換與協作平台) 緊密協作，共同構建一個強大且靈活的數位孿生生態系統。NDH 負責資料的處理、分析與服務提供，IADL 提供標準化的資產描述，而 Omniverse 則提供高效的 3D 視覺化與即時協同環境。

## 3. NDH 核心架構

NDH 採用模組化、分層式的架構設計，以確保其可擴展性、可維護性和高效能。其核心組件包括資料管理層、服務層和應用層。

![NDH Architecture](../images/ndh_architecture.png)

**3.1. 資料管理層**

此層負責所有數位孿生相關資料的攝取、儲存、管理和標準化。它支援多種資料格式，並透過 IADL 進行統一描述。

*   **IADL 解析器**：負責解析符合 IADL 標準的資產描述檔案，將其轉換為 NDH 內部可處理的資料結構。這確保了不同來源資料的互操作性。
*   **資料庫系統**：採用混合式儲存策略，結合關係型資料庫（如 PostgreSQL）用於結構化資料和文件型資料庫（如 MongoDB）用於非結構化資料，以支援多樣化的資料需求。
*   **檔案儲存**：支援分散式檔案儲存系統（如 MinIO 或 S3 兼容儲存），用於存放大型模型檔案、點雲資料和歷史記錄。

**3.2. 服務層**

服務層是 NDH 的核心功能實現，提供各種專業的工程分析與協作服務。所有服務均以微服務 (Microservices) 形式部署，便於獨立擴展和維護。

*   **MEP 設計服務**：提供基於規則和參數化的 MEP 系統設計輔助功能，包括自動佈線、元件選型和性能評估。它能夠根據預設規範和最佳實踐，生成初步的 MEP 設計方案。
*   **衝突檢測服務**：利用高效的幾何演算法（如 GJK/EPA 演算法結合 BVH 樹等廣相篩選技術）對 3D 模型進行精確的衝突檢測，識別不同專業（結構、MEP、建築）之間的碰撞點，並提供衝突報告和視覺化。
*   **ISO 圖面生成服務**：根據 3D 模型和預設的繪圖標準，自動生成符合 ISO 標準的 2D 工程圖，包括平面圖、立面圖、剖面圖和詳圖，極大提高出圖效率。
*   **流體分析服務 (Flow Analysis)**：整合計算流體力學 (CFD) 模擬能力，對管道系統、通風系統等進行流體行為分析，評估壓力損失、流速分佈和熱傳遞效率，優化系統性能。
*   **即時協同服務**：提供多用戶在同一 3D 環境下進行即時協同作業的能力，包括模型審閱、批註、版本控制和任務分配。透過 Omniverse 的資料交換能力，確保協同過程中的資料一致性。

**3.3. 應用層**

應用層是 NDH 與用戶互動的介面，提供直觀的視覺化和操作工具。

*   **Web 應用**：基於現代前端框架（如 React 或 Vue.js）開發，提供跨平台的訪問能力。
*   **桌面應用**：針對需要更高性能和更複雜操作的場景，提供基於 Qt 或 Electron 的桌面客戶端。
*   **API 介面**：提供標準化的 RESTful API 和 GraphQL API，方便第三方應用程式和服務與 NDH 進行整合。

## 4. 關鍵技術實現

### 4.1. 衝突檢測

NDH 的衝突檢測服務採用多階段策略，結合廣相和窄相檢測，以實現高效且精確的碰撞識別。我們利用開源的碰撞檢測函式庫，並針對工業場景進行優化。

*   **廣相檢測 (Broad-Phase Detection)**：使用包圍盒層次結構 (Bounding Volume Hierarchies, BVH) 或空間分割結構（如八叉樹）快速排除大部分不相交的物體對，大幅減少需要進行精確檢測的數量。這一步驟的目標是快速篩選出潛在的碰撞對。
*   **窄相檢測 (Narrow-Phase Detection)**：對於廣相檢測篩選出的潛在碰撞對，採用 GJK (Gilbert-Johnson-Keerthi) 和 EPA (Expanding Polytope Algorithm) 演算法進行精確的碰撞檢測。GJK 用於判斷兩個凸體是否相交，若相交，EPA 則用於計算穿透深度和接觸點。

**程式碼範例 (概念性)**：

```cpp
// 假設使用一個抽象的碰撞檢測庫
#include "CollisionDetector.h"
#include "Model.h"

std::vector<CollisionResult> detectCollisions(const std::vector<Model>& models)
{
    CollisionDetector detector;
    std::vector<CollisionResult> results;

    // 廣相檢測：構建 BVH 樹並篩選潛在碰撞對
    detector.buildBroadPhase(models);
    std::vector<std::pair<Model, Model>> potentialPairs = detector.getPotentialCollisionPairs();

    // 窄相檢測：對潛在碰撞對執行 GJK/EPA
    for (const auto& pair : potentialPairs)
    {
        if (detector.gjkDetect(pair.first, pair.second))
        {
            CollisionResult result = detector.epaResolve(pair.first, pair.second);
            results.push_back(result);
        }
    }
    return results;
}
```

### 4.2. MEP 設計與自動化

NDH 的 MEP 設計服務透過整合參數化模型和規則引擎，實現設計過程的自動化和智慧化。用戶可以定義設計規範、材料屬性和連接規則，系統將自動生成符合要求的 MEP 佈局。

*   **參數化元件庫**：建立包含各類 MEP 元件（管道、電纜橋架、風管、設備等）的參數化模型庫，每個元件都帶有幾何資訊、連接點、屬性（如流量、電壓、壓力等級）和行為規則。
*   **規則引擎**：基於用戶定義的設計規範和行業標準，實現自動佈線、尺寸計算、元件選型和衝突規避。例如，可以設定管道最小間距、彎頭半徑、電纜橋架的填充率等。
*   **拓撲分析**：對 MEP 系統的連接關係進行拓撲分析，確保系統的完整性和可追溯性，並為流體分析提供基礎數據。

### 4.3. ISO 圖面生成

NDH 的 ISO 圖面生成服務能夠從 3D 模型中自動提取資訊，並按照預設的 ISO 標準生成 2D 工程圖。這包括自動標註、符號插入和圖框管理。

*   **視圖生成**：從 3D 模型中自動生成正交視圖（俯視、前視、側視）、等軸測視圖和剖面視圖。
*   **自動標註**：根據模型尺寸和用戶設定，自動添加尺寸標註、公差標註和表面粗糙度符號。
*   **符號庫**：內置符合 ISO 標準的工程符號庫，如焊接符號、表面處理符號、管路元件符號等，並支援用戶自定義。
*   **圖框與標題欄**：自動套用標準圖框和標題欄，並填充專案資訊、圖紙編號、比例等。

### 4.4. 流體分析 (Flow Analysis)

NDH 整合了輕量級的 CFD 模擬功能，允許工程師在設計階段對流體系統進行快速評估。這有助於優化管道佈局、泵選型和通風效率。

*   **網格生成**：支援對複雜幾何體進行自動或半自動的網格劃分，為 CFD 模擬準備計算域。
*   **求解器**：內置基於有限體積法 (Finite Volume Method) 的求解器，能夠計算穩態或非穩態的流場、壓力場和溫度場。
*   **結果視覺化**：提供流線、等值線、向量場等視覺化工具，直觀展示模擬結果，幫助工程師理解流體行為。

### 4.5. 即時協同

NDH 的即時協同能力是透過與 Omniverse 的深度整合實現的。Omniverse 提供了一個通用場景描述 (USD) 框架，允許多個用戶在不同應用程式之間進行即時資料交換和協同編輯。

*   **USD (Universal Scene Description) 整合**：NDH 內部資料模型與 USD 進行映射，確保所有設計資料都能以 USD 格式在 Omniverse 中進行發布和訂閱。這使得不同專業的設計師可以在各自熟悉的工具中工作，並即時看到其他人的修改。
*   **版本控制與審閱**：利用 Omniverse 的版本控制能力，追蹤所有協同編輯的歷史記錄，並提供強大的審閱工具，包括批註、標記和問題追蹤。
*   **多用戶同步**：實現多個用戶在同一 3D 場景中的即時位置同步、視角同步和模型操作同步，提升協同效率。

## 5. 結論

NDH V3.1 的設計旨在為 IDTF 框架提供一個強大、靈活且開放的數位中樞。透過整合 IDTF V2 的核心理念，並提供 MEP 設計、衝突檢測、ISO 圖面生成、流體分析和即時協同等原生能力，NDH 有力地支援了工業數位孿生在設計、建造和運維全生命週期的應用。其模組化架構和對開放標準的堅持，確保了 IDTF 在未來工業數位化領域的領先地位和廣闊前景。
