# NDH 與 MES/ERP 系統整合需求分析

## 目錄

1. [整合背景](#整合背景)
2. [MES 系統概述](#mes-系統概述)
3. [ERP 系統概述](#erp-系統概述)
4. [ISA-95 標準與整合層次](#isa-95-標準與整合層次)
5. [常見 MES/ERP 系統](#常見-meserp-系統)
6. [整合需求分析](#整合需求分析)
7. [資料交換場景](#資料交換場景)
8. [技術挑戰](#技術挑戰)

## 整合背景

### 為什麼需要 MES/ERP 整合?

在現代製造業中,**MES (Manufacturing Execution System)** 和 **ERP (Enterprise Resource Planning)** 系統扮演著不同但互補的角色:

```
┌─────────────────────────────────────────────────────────┐
│                    企業層級                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │              ERP (企業資源規劃)                   │   │
│  │  - 訂單管理                                       │   │
│  │  - 物料需求計畫 (MRP)                             │   │
│  │  - 財務管理                                       │   │
│  │  - 供應鏈管理                                     │   │
│  └────────────────┬────────────────────────────────┘   │
└───────────────────┼──────────────────────────────────────┘
                    │ 工單、BOM、排程
                    ▼
┌─────────────────────────────────────────────────────────┐
│                    製造層級                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │              MES (製造執行系統)                   │   │
│  │  - 生產排程執行                                   │   │
│  │  - 製程監控                                       │   │
│  │  - 品質管理                                       │   │
│  │  - 設備管理                                       │   │
│  │  - 物料追蹤                                       │   │
│  └────────────────┬────────────────────────────────┘   │
└───────────────────┼──────────────────────────────────────┘
                    │ 生產資料、設備狀態
                    ▼
┌─────────────────────────────────────────────────────────┐
│                    控制層級                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │              NDH (中立資料中樞)                   │   │
│  │  - 資產資料整合                                   │   │
│  │  - 即時資料收集                                   │   │
│  │  - 事件處理                                       │   │
│  └────────────────┬────────────────────────────────┘   │
└───────────────────┼──────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│              SCADA / PLC / 工業設備                      │
└─────────────────────────────────────────────────────────┘
```

### NDH 在整合中的角色

NDH 作為**中立資料中樞**,在 MES/ERP 整合中扮演關鍵角色:

1. **向下整合**: 從 SCADA、PLC、工業設備收集即時資料
2. **向上整合**: 將生產資料推送到 MES/ERP
3. **資料標準化**: 提供統一的資料模型 (IADL)
4. **事件驅動**: 透過 Kafka 實現事件溯源和資料流

## MES 系統概述

### MES 核心功能

根據 ISA-95 標準,MES 包含 11 大核心功能:

| 功能 | 說明 | 與 NDH 的整合點 |
|------|------|----------------|
| **1. 資源分配與狀態管理** | 管理設備、工具、人員等資源 | NDH 提供設備即時狀態 |
| **2. 作業/詳細排程** | 排程生產作業順序 | NDH 提供設備可用性資訊 |
| **3. 生產單元分配** | 分配工單到生產單元 | NDH 追蹤生產單元狀態 |
| **4. 文件控制** | 管理製程文件和作業指導書 | NDH 提供設備參數和配方 |
| **5. 資料收集/獲取** | 收集生產過程資料 | **NDH 核心功能** |
| **6. 人力資源管理** | 管理人員技能和出勤 | NDH 記錄操作員操作 |
| **7. 品質管理** | 管理品質檢驗和分析 | NDH 提供檢測設備資料 |
| **8. 製程管理** | 監控和控制製程 | NDH 提供製程參數 |
| **9. 維護管理** | 設備維護和保養 | NDH 提供設備健康狀態 |
| **10. 產品追蹤與清單** | 追蹤產品和物料 | NDH 提供物料位置和狀態 |
| **11. 績效分析** | 分析 OEE 和生產效率 | NDH 提供設備運行資料 |

### MES 資料模型

```python
# MES 核心資料實體

class WorkOrder:
    """工單"""
    work_order_id: str          # 工單編號
    product_id: str             # 產品編號
    quantity: int               # 數量
    scheduled_start: datetime   # 計畫開始時間
    scheduled_end: datetime     # 計畫結束時間
    status: str                 # 狀態 (Released, InProgress, Completed)
    priority: int               # 優先級

class ProductionEvent:
    """生產事件"""
    event_id: str               # 事件 ID
    work_order_id: str          # 工單編號
    event_type: str             # 事件類型 (Start, Complete, Pause)
    timestamp: datetime         # 時間戳
    quantity: int               # 數量
    operator_id: str            # 操作員 ID
    equipment_id: str           # 設備 ID

class QualityRecord:
    """品質記錄"""
    record_id: str              # 記錄 ID
    work_order_id: str          # 工單編號
    inspection_type: str        # 檢驗類型
    result: str                 # 結果 (Pass, Fail)
    defect_code: str            # 缺陷代碼
    inspector_id: str           # 檢驗員 ID
    timestamp: datetime         # 時間戳

class MaterialConsumption:
    """物料消耗"""
    consumption_id: str         # 消耗 ID
    work_order_id: str          # 工單編號
    material_id: str            # 物料編號
    quantity: float             # 數量
    lot_number: str             # 批號
    timestamp: datetime         # 時間戳
```

## ERP 系統概述

### ERP 核心模組

| 模組 | 說明 | 與 NDH 的整合點 |
|------|------|----------------|
| **銷售與訂單管理** | 管理客戶訂單 | 接收訂單資訊 |
| **物料需求計畫 (MRP)** | 計算物料需求 | 提供實際消耗資料 |
| **生產計畫** | 制定生產計畫 | 接收計畫,回報進度 |
| **庫存管理** | 管理原料和成品庫存 | 回報實際消耗和產出 |
| **採購管理** | 管理供應商和採購 | 提供物料需求資訊 |
| **財務管理** | 成本核算和財務報表 | 提供生產成本資料 |
| **品質管理** | 品質政策和審核 | 回報品質資料 |

### ERP 資料模型

```python
# ERP 核心資料實體

class SalesOrder:
    """銷售訂單"""
    order_id: str               # 訂單編號
    customer_id: str            # 客戶編號
    order_date: datetime        # 訂單日期
    delivery_date: datetime     # 交貨日期
    items: List[OrderItem]      # 訂單項目
    status: str                 # 狀態

class BillOfMaterials:
    """物料清單 (BOM)"""
    bom_id: str                 # BOM 編號
    product_id: str             # 產品編號
    version: str                # 版本
    items: List[BOMItem]        # BOM 項目
    
class BOMItem:
    """BOM 項目"""
    material_id: str            # 物料編號
    quantity: float             # 數量
    unit: str                   # 單位
    scrap_rate: float           # 損耗率

class InventoryTransaction:
    """庫存交易"""
    transaction_id: str         # 交易 ID
    material_id: str            # 物料編號
    transaction_type: str       # 交易類型 (Receipt, Issue, Transfer)
    quantity: float             # 數量
    location: str               # 位置
    timestamp: datetime         # 時間戳
    reference: str              # 參考 (工單編號等)

class ProductionOrder:
    """生產訂單 (ERP 視角)"""
    order_id: str               # 訂單編號
    product_id: str             # 產品編號
    quantity: int               # 數量
    planned_start: datetime     # 計畫開始
    planned_end: datetime       # 計畫結束
    status: str                 # 狀態
    cost: float                 # 成本
```

## ISA-95 標準與整合層次

### ISA-95 五層架構

ISA-95 標準定義了企業和控制系統的整合模型:

```
┌─────────────────────────────────────────────────────────┐
│  Level 4: 企業資源規劃層 (ERP)                           │
│  - 企業物流                                               │
│  - 訂單處理                                               │
│  - 財務管理                                               │
└────────────────┬────────────────────────────────────────┘
                 │ 3-4 介面: 工單、BOM、排程 ↓
                 │          生產報告、庫存 ↑
┌────────────────▼────────────────────────────────────────┐
│  Level 3: 製造執行系統層 (MES)                           │
│  - 生產排程                                               │
│  - 製程管理                                               │
│  - 品質管理                                               │
└────────────────┬────────────────────────────────────────┘
                 │ 2-3 介面: 生產指令 ↓
                 │          生產資料、設備狀態 ↑
┌────────────────▼────────────────────────────────────────┐
│  Level 2: 監控層 (SCADA / NDH)                           │
│  - 資料收集                                               │
│  - 設備監控                                               │
│  - 資料整合                                               │
└────────────────┬────────────────────────────────────────┘
                 │ 1-2 介面: 控制命令 ↓
                 │          感測器資料 ↑
┌────────────────▼────────────────────────────────────────┐
│  Level 1: 控制層 (PLC, DCS)                              │
│  - 製程控制                                               │
│  - 邏輯控制                                               │
└────────────────┬────────────────────────────────────────┘
                 │
┌────────────────▼────────────────────────────────────────┐
│  Level 0: 實體層 (感測器, 致動器)                         │
│  - 感測                                                   │
│  - 致動                                                   │
└─────────────────────────────────────────────────────────┘
```

### NDH 在 ISA-95 中的定位

NDH 主要位於 **Level 2 (監控層)**,並向上整合到 **Level 3 (MES)** 和 **Level 4 (ERP)**:

- **Level 0-1 → NDH**: 透過 OPC UA、Modbus 等協定收集資料
- **NDH → Level 2**: 提供 SCADA 功能和資料整合
- **NDH → Level 3**: 向 MES 提供即時生產資料
- **NDH → Level 4**: 向 ERP 提供生產完成和庫存資料

## 常見 MES/ERP 系統

### 主流 MES 系統

| 系統 | 廠商 | 特點 | API 類型 |
|------|------|------|---------|
| **Siemens Opcenter** | Siemens | 完整的 MES 套件 | REST API, OPC UA |
| **Rockwell FactoryTalk** | Rockwell | 與 Allen-Bradley PLC 整合 | REST API, .NET SDK |
| **AVEVA MES** | AVEVA | 與 System Platform 整合 | REST API, SOAP |
| **Dassault DELMIA** | Dassault | 數位製造平台 | REST API |
| **Apriso** | Dassault | 彈性製造 MES | REST API, Web Services |
| **Wonderware MES** | AVEVA | 與 Wonderware 整合 | REST API, COM |
| **Plex MES** | Plex | 雲端 MES | REST API |
| **Parsec TrakSYS** | Parsec | 即時生產管理 | REST API, OPC |

### 主流 ERP 系統

| 系統 | 廠商 | 特點 | API 類型 |
|------|------|------|---------|
| **SAP ERP** | SAP | 企業級 ERP 領導者 | REST API, BAPI, IDoc |
| **Oracle ERP Cloud** | Oracle | 雲端 ERP | REST API, SOAP |
| **Microsoft Dynamics 365** | Microsoft | 整合 Office 365 | REST API, OData |
| **Infor CloudSuite** | Infor | 產業專用 ERP | REST API |
| **IFS Applications** | IFS | 製造業 ERP | REST API, SOAP |
| **Epicor ERP** | Epicor | 中小企業 ERP | REST API |
| **QAD ERP** | QAD | 製造業專用 | REST API, Web Services |
| **鼎新 ERP** | 鼎新電腦 | 台灣本土 ERP | REST API, Web Services |

### 台灣常見系統

| 系統 | 廠商 | 市場定位 | 整合方式 |
|------|------|---------|---------|
| **鼎新 Workflow ERP** | 鼎新電腦 | 中大型企業 | REST API, Web Services |
| **正航 ERP** | 正航資訊 | 中小企業 | REST API, COM |
| **天心 ERP** | 天心資訊 | 中小企業 | REST API |
| **資通 ciMes** | 資通電腦 | MES 系統 | REST API, OPC |
| **盟立 MES** | 盟立自動化 | 半導體 MES | REST API |

## 整合需求分析

### 功能需求

#### 1. 從 ERP 到 MES (向下整合)

| 資料類型 | 說明 | 頻率 | 優先級 |
|---------|------|------|--------|
| **生產訂單** | 工單資訊、產品、數量 | 即時 | 高 |
| **物料清單 (BOM)** | 產品配方和物料需求 | 按需 | 高 |
| **生產排程** | 計畫開始/結束時間 | 每日 | 高 |
| **物料庫存** | 可用物料和庫存位置 | 每小時 | 中 |
| **品質標準** | 檢驗規格和標準 | 按需 | 中 |

#### 2. 從 MES 到 ERP (向上整合)

| 資料類型 | 說明 | 頻率 | 優先級 |
|---------|------|------|--------|
| **生產完成報告** | 實際產出數量和時間 | 即時 | 高 |
| **物料消耗** | 實際使用的物料和數量 | 即時 | 高 |
| **品質資料** | 檢驗結果和不良品 | 即時 | 高 |
| **設備狀態** | OEE、停機時間 | 每小時 | 中 |
| **庫存異動** | 在製品和成品異動 | 即時 | 高 |

#### 3. NDH 的資料收集 (向下整合)

| 資料類型 | 來源 | 說明 |
|---------|------|------|
| **設備狀態** | SCADA/PLC | 運行、停機、故障 |
| **製程參數** | 感測器 | 溫度、壓力、流量 |
| **產量計數** | 計數器 | 實際產出數量 |
| **品質檢測** | 檢測設備 | 尺寸、重量、外觀 |
| **物料追蹤** | RFID/條碼 | 物料位置和批號 |

### 非功能需求

| 需求 | 目標 | 說明 |
|------|------|------|
| **即時性** | < 5 秒 | 關鍵資料的延遲 |
| **可靠性** | 99.9% | 系統可用性 |
| **資料完整性** | 100% | 不允許資料遺失 |
| **可擴展性** | 10,000+ 設備 | 支援大規模部署 |
| **安全性** | 符合 ISO 27001 | 資料加密和存取控制 |

## 資料交換場景

### 場景 1: 工單下達與執行

```
ERP                    MES                    NDH                    設備
 │                      │                      │                      │
 │──生產訂單───────────→│                      │                      │
 │  (工單、BOM、排程)    │                      │                      │
 │                      │                      │                      │
 │                      │──工單分配───────────→│                      │
 │                      │  (設備、物料、參數)   │                      │
 │                      │                      │                      │
 │                      │                      │──下載配方───────────→│
 │                      │                      │  (製程參數)          │
 │                      │                      │                      │
 │                      │                      │←─設備狀態───────────│
 │                      │←─生產開始事件───────│  (Ready)             │
 │                      │                      │                      │
 │                      │                      │←─生產資料───────────│
 │                      │←─即時產量───────────│  (計數、參數)        │
 │                      │                      │                      │
 │←─生產進度報告───────│                      │                      │
 │  (完成數量、時間)     │                      │                      │
```

### 場景 2: 物料消耗與庫存更新

```
ERP                    MES                    NDH                    RFID/條碼
 │                      │                      │                      │
 │──物料資訊───────────→│                      │                      │
 │  (庫存、批號)         │                      │                      │
 │                      │                      │                      │
 │                      │──物料需求───────────→│                      │
 │                      │                      │                      │
 │                      │                      │←─物料掃描───────────│
 │                      │←─物料消耗事件───────│  (批號、數量)        │
 │                      │                      │                      │
 │←─庫存異動───────────│                      │                      │
 │  (發料、退料)         │                      │                      │
```

### 場景 3: 品質檢驗與追溯

```
ERP                    MES                    NDH                    檢測設備
 │                      │                      │                      │
 │──品質標準───────────→│                      │                      │
 │  (規格、公差)         │                      │                      │
 │                      │                      │                      │
 │                      │──檢驗指令───────────→│                      │
 │                      │                      │                      │
 │                      │                      │──啟動檢測───────────→│
 │                      │                      │                      │
 │                      │                      │←─檢測結果───────────│
 │                      │←─品質資料───────────│  (Pass/Fail)         │
 │                      │                      │                      │
 │←─品質報告───────────│                      │                      │
 │  (良率、缺陷)         │                      │                      │
```

### 場景 4: 設備效率分析 (OEE)

```
ERP                    MES                    NDH                    設備
 │                      │                      │                      │
 │                      │                      │←─設備狀態───────────│
 │                      │                      │  (運行/停機/故障)    │
 │                      │                      │                      │
 │                      │←─OEE 資料───────────│                      │
 │                      │  (可用率、效率、良率) │                      │
 │                      │                      │                      │
 │←─設備效率報告───────│                      │                      │
 │  (OEE、停機原因)      │                      │                      │
```

## 技術挑戰

### 1. 資料同步挑戰

| 挑戰 | 說明 | 解決方案 |
|------|------|---------|
| **即時性 vs 批次** | ERP 通常是批次處理,MES 需要即時 | 使用訊息佇列緩衝 |
| **資料一致性** | 多系統間的資料一致性 | 事件溯源 + 最終一致性 |
| **網路中斷** | 網路故障時的資料處理 | 本地緩衝 + 重試機制 |
| **大量資料** | 設備產生大量資料 | 資料聚合 + 壓縮 |

### 2. 系統整合挑戰

| 挑戰 | 說明 | 解決方案 |
|------|------|---------|
| **API 差異** | 不同系統的 API 不一致 | 統一的連接器介面 |
| **資料格式** | 不同的資料格式和標準 | 資料轉換層 |
| **認證機制** | 各系統的認證方式不同 | 統一的認證管理 |
| **版本相容** | 系統升級導致的相容性問題 | 版本管理 + 適配器模式 |

### 3. 業務邏輯挑戰

| 挑戰 | 說明 | 解決方案 |
|------|------|---------|
| **工單狀態同步** | ERP 和 MES 的工單狀態不一致 | 狀態機 + 事件驅動 |
| **物料追溯** | 批號和序號的追溯 | 完整的事件記錄 |
| **異常處理** | 生產異常的處理流程 | 工作流引擎 |
| **資料校正** | 錯誤資料的校正機制 | 補償事務 |

### 4. 效能挑戰

| 挑戰 | 說明 | 解決方案 |
|------|------|---------|
| **高併發** | 多個設備同時上報資料 | 非同步處理 + 負載平衡 |
| **大資料量** | 歷史資料查詢效能 | 資料分層 + 快取 |
| **複雜查詢** | 跨系統的複雜查詢 | 資料倉儲 + OLAP |

## 總結

NDH 與 MES/ERP 的整合是一個複雜但關鍵的任務,需要:

1. **標準化**: 遵循 ISA-95 標準
2. **事件驅動**: 使用 Kafka 實現事件溯源
3. **彈性設計**: 支援多種 MES/ERP 系統
4. **可靠性**: 確保資料不遺失
5. **即時性**: 滿足生產即時性需求

下一步將設計具體的整合架構和連接器實作。

---

**作者**: 林志錚 Michael Lin(Chih Cheng Lin)(Chih Cheng Lin) (Chih-Cheng Lin, Michael Lin)  
**版權**: © 2025 版權所有  
**最後更新**: 2025-01-10

